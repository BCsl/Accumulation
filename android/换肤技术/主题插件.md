# 主题插件

有点类似于换肤功能

## 按照APK的形式

主题加载器的主要思路，通过PMS可以读取指定包名下APK的资源对象Resources，获取到Resources对象后，就可以通过读取到主题包的主题模板XML信息，由于主包的R文件并不包含主题包的资源，所以不能通过资源引用来读取资源，需要通过`Resources.getIdentifier`方法，为了统一性，主包也应该用这种方式来加载主题资源

获取指定包名的`Resources`对象

```java
Resources mResources = getPackageManager().getResourcesForApplication(mPkgName);
```

## 非安装APK的形式

**最关键**的就是得到皮肤文件的Resources对象和资源ID。资源ID在皮肤apk打包的时候已经编译好，可以通过**反射**的方式获取**R$资源**（甚至其他类，加载为安装的Apk的类需要用到DexClassLoader），然后获取到资源ID，获取到ID还不够，还需要构造出插件包的`Resources`对象才能获取到具体的资源

```java
AssetManager assetManager = AssetManager.class.newInstance();
Method addAssetPath = assetManager.getClass().getMethod("addAssetPath", String.class);
addAssetPath.invoke(assetManager, apkPath);
Resources superRes = context.getResources();
superRes.getDisplayMetrics();
superRes.getConfiguration();
mResources = new Resources(assetManager, superRes.getDisplayMetrics(), superRes.getConfiguration());
//用于插件包类的加载
mDexClassLoader = new DexClassLoader(apkPath, context.getDir("dex", 0).getAbsolutePath(), null, context.getClassLoader());
```

## 参考

- [Android插件原理剖析](http://www.alloyteam.com/2014/04/android-cha-jian-yuan-li-pou-xi/?utm_source=tuicool&utm_medium=referral)

- [Android插件化探索系列](http://blog.csdn.net/maplejaw_/article/details/51596374)

- [从源码分析 Android dexClassLoader 加载机制原理](http://blog.csdn.net/nanzhiwen666/article/details/50515895)

- [Android热修复学习](http://blog.csdn.net/xiandan87/article/details/51734200)
